# Demand-OS: 对话式执行引擎交付文档

**版本**: 1.0  
**日期**: 2026-02-07  
**作者**: Manus AI

---

## 📋 项目概述

本文档记录了 **Demand-OS 对话式执行引擎** 的完整实现。该引擎是一个**状态机驱动的对话系统**，用户通过聊天界面与系统交互，系统按照预定义的工作流步骤引导用户完成任务。这与之前"生成工作流图"的方案完全不同，它是真正的"对话式执行"。

### 核心理念

1. **用户不可见工作流**: 工作流在后端定义，用户只通过对话与系统交互，看不到任何流程图。
2. **状态驱动**: 系统始终追踪当前对话处于哪个工作流的哪个步骤。
3. **一问一答**: 交互模式是"系统提问 -> 用户回答 -> 系统执行 -> 系统提问下一个问题"。

---

## 🎯 核心成果

### 1. 状态机架构设计

我们设计了一个完整的状态机架构，包括：

- **工作流模板定义** (`workflow-templates.ts`)：定义了工作流的所有步骤、转移条件和执行逻辑。
- **步骤类型**：
  - `user_input`: 等待用户输入
  - `system_action`: 系统执行后台操作（如调用 AI、查询数据库）
  - `end`: 对话结束

### 2. 后端 API 实现

创建了 `/api/chat/converse` API，负责：

- **会话管理**: 使用内存存储（生产环境可替换为 Redis）追踪每个用户的对话状态。
- **状态机执行**: 根据当前步骤和用户输入，自动执行 `system_action` 并转移到下一个步骤。
- **智能循环**: 自动执行所有 `system_action` 步骤，直到遇到 `user_input` 或 `end`。

### 3. 前端聊天界面

创建了 `/assistant` 页面，提供：

- **工作流选择**: 用户可以选择"海外寻源"或"工厂委托开发"。
- **聊天界面**: 经典的聊天 UI，支持用户输入和系统消息展示。
- **加载状态**: 当系统执行 `system_action` 时，显示"正在处理..."。
- **对话完成**: 对话结束后，用户可以选择"开始新对话"。

### 4. 预定义工作流

实现了两个示例工作流：

#### 海外寻源工作流
1. 用户输入 TikTok 视频链接
2. 系统分析视频内容和市场潜力
3. 系统展示分析结果，询问是否匹配工厂
4. 系统匹配工厂并展示结果
5. 对话结束

#### 工厂委托开发工作流
1. 用户描述产品需求
2. 系统分析需求和技术要求
3. 系统展示评估结果
4. 对话结束

---

## 📦 交付内容

### 文档（2 份）

| 文档名称 | 路径 | 描述 |
| :--- | :--- | :--- |
| **架构设计文档** | `docs/CONVERSATIONAL_EXECUTION_ENGINE_ARCHITECTURE.md` | 详细的状态机设计、API 规范和实施计划 |
| **交付文档** | `docs/CONVERSATIONAL_EXECUTION_ENGINE_DELIVERY.md` | 本文档，总结实现成果和使用指南 |

### 代码（5 个文件）

| 文件路径 | 描述 | 代码行数 |
| :--- | :--- | :---: |
| `web/src/lib/workflow-templates.ts` | 工作流模板定义，包含"海外寻源"和"工厂委托开发"两个工作流 | 180 |
| `web/src/app/api/chat/converse/route.ts` | 对话式执行 API，处理会话管理和状态机执行 | 140 |
| `web/src/app/assistant/page.tsx` | 前端聊天界面，支持工作流选择和对话交互 | 150 |
| `web/src/components/chat-message.tsx` | 聊天消息组件，支持 Markdown 渲染 | 40 |

**总计**: 5 个文件，约 510 行代码。

---

## 🚀 使用指南

### 1. 启动项目

```bash
cd web
pnpm dev
```

### 2. 访问对话式助手

打开浏览器访问: `http://localhost:3000/assistant`

### 3. 开始对话

1. 在首页选择一个服务（如"海外寻源"）
2. 系统会自动开始对话，提出第一个问题
3. 在输入框中输入回复，按 `Enter` 发送
4. 系统会自动执行后台操作（如分析视频），并继续提问
5. 按照系统引导完成整个流程

### 示例对话流程

```
[用户选择"海外寻源"]

系统: 您好！我是 Demand-OS 海外寻源助手。
      请提供您想分析的 TikTok 视频链接，我将为您分析其市场潜力并匹配合适的工厂。

用户: https://tiktok.com/xxx

系统: 正在分析视频内容和市场潜力...
      (2 秒后)
      ✅ 分析完成！
      
      **产品信息**
      - 产品名称: 便携式蓝牙音箱
      - 类别: 电子产品
      - 市场潜力: 高
      - 预估需求: 10,000+ 件/月
      - 目标市场: 北美
      
      是否继续为您匹配合适的工厂？（输入"是"或"否"）

用户: 是

系统: 正在为您匹配合适的工厂...
      (2 秒后)
      ✅ 已为您找到 3 家合适的工厂：
      
      1. **深圳市创新电子有限公司**
         - 位置: 深圳
         - 评分: 4.8/5.0
      
      2. **东莞市精工制造厂**
         - 位置: 东莞
         - 评分: 4.6/5.0
      
      3. **广州市智能科技公司**
         - 位置: 广州
         - 评分: 4.5/5.0
      
      您可以输入工厂编号（1-3）查看详情，或输入"完成"结束对话。

用户: 完成

系统: 感谢使用 Demand-OS 海外寻源服务！如有其他需求，请随时联系我们。
```

---

## 🎨 核心优势

### 1. 对标 Accio 的核心体验

Accio 的核心是"对话式搜索引擎"，我们的对话式执行引擎完全对标这一理念。用户无需学习复杂的拖拽编辑，只需按照系统引导一步步完成任务。

### 2. 适合政府和产业园区展示

在展示时，只需选择一个服务，系统就会自动引导完成整个流程。这种"智能助手"的体验远比手动拖拽更具说服力，能够直观地展示 AI 的智能化能力。

### 3. 简约的科技感

界面设计简洁优雅，没有复杂的动画效果，体现出专业的科技感。聊天界面是用户最熟悉的交互方式，降低了学习成本。

### 4. 可扩展性强

- **添加新工作流**: 只需在 `workflow-templates.ts` 中定义新的工作流模板。
- **集成真实 AI**: 将 `system_action` 中的模拟逻辑替换为真实的 AI API 调用。
- **持久化会话**: 将内存存储替换为 Redis，支持跨设备和长时间会话。

---

## 🔧 技术细节

### API 请求示例

```bash
curl -X POST http://localhost:3000/api/chat/converse \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "session-123",
    "workflowId": "overseas-sourcing"
  }'
```

### API 响应示例

```json
{
  "sessionId": "session-123",
  "systemMessage": "您好！我是 Demand-OS 海外寻源助手。\n\n请提供您想分析的 TikTok 视频链接...",
  "isWaitingForInput": true,
  "isCompleted": false
}
```

---

## 📊 与之前方案的对比

| 维度 | 之前的"生成工作流图"方案 | 当前的"对话式执行"方案 |
| :--- | :--- | :--- |
| **用户体验** | 用户看到一个复杂的流程图 | 用户只看到聊天对话 |
| **交互方式** | 用户需要理解流程图的结构 | 用户只需回答问题 |
| **展示效果** | 适合技术人员，不适合政府展示 | 适合所有人，尤其是政府展示 |
| **实现复杂度** | 需要复杂的 Prompt 工程生成 JSON | 预定义工作流模板，逻辑清晰 |
| **可维护性** | AI 生成的结果不稳定 | 工作流模板可控，易于维护 |

---

## 🚧 未来优化方向

1. **集成真实 AI 分析**：将模拟的视频分析替换为真实的 AI API 调用（如 GPT-4 Vision）。
2. **持久化会话**：使用 Redis 存储会话状态，支持跨设备和长时间会话。
3. **多轮对话优化**：支持用户在对话中修改之前的输入，或返回上一步。
4. **富媒体消息**：支持在对话中展示图片、表格、图表等富媒体内容。
5. **语音输入**：支持用户通过语音输入，进一步降低交互门槛。

---

## 📄 GitHub 提交

- **仓库**: `magicy565-web/demand-os`
- **提交 ID**: `68f67c2`
- **分支**: `main`
- **提交信息**: "feat: Implement conversational execution engine with state machine"

---

## 🎉 总结

对话式执行引擎是 Demand-OS 项目的核心创新，它真正实现了"对话驱动，自动执行"的理念。用户无需学习复杂的工作流编辑，只需通过聊天界面与系统交互，系统就会自动引导完成整个流程。这种体验非常适合向政府和产业园区展示，能够直观地展示 AI 的智能化能力。

---

**作者**: Manus AI  
**日期**: 2026-02-07
